name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---------- FRONTEND ----------
      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Build React app
        working-directory: client
        run: npm run build

      - name: Verify React build
        run: |
          test -f client/dist/index.html || (echo "âŒ React build missing index.html" && exit 1)

      - name: Deploy frontend to nginx root
        run: |
          sudo rm -rf /home/sam/app/client/dist
          sudo mkdir -p /home/sam/app/client
          sudo cp -r client/dist /home/sam/app/client/dist
          sudo chown -R sam:www-data /home/sam/app/client/dist
          sudo chmod -R 755 /home/sam/app/client/dist

      # ---------- BACKEND ----------
      - name: Install server dependencies
        working-directory: server
        run: npm ci --omit=dev

      - name: Deploy backend to server directory
        run: |
          sudo rm -rf /home/sam/app/server/*
          sudo mkdir -p /home/sam/app/server
          sudo cp -r server/* /home/sam/app/server/
          sudo cp -r server/node_modules /home/sam/app/server/
          sudo chown -R sam:sam /home/sam/app/server
          sudo chmod -R 755 /home/sam/app/server

      - name: Write backend .env from secrets
        run: |
          sudo tee /home/sam/app/server/.env > /dev/null <<EOF
          PORT=${{ secrets.PORT }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          API_KEY=${{ secrets.API_KEY }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          DB_NAME=${{ secrets.DB_NAME }}
<<<<<<< HEAD
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
=======
          JWT_SECRET=${{ secrets.JWT_SECRET }}
>>>>>>> 2c96914 (feat: enhance deployment workflow and improve dark theme styling)
          EOF
          sudo chown sam:sam /home/sam/app/server/.env
          sudo chmod 600 /home/sam/app/server/.env

      - name: Restart PM2
        run: |
          cd /home/sam/app
          pm2 reload ecosystem.config.cjs --env production
          pm2 save

      - name: Reload Nginx
<<<<<<< HEAD
        run: sudo nginx -t && sudo systemctl reload nginx
=======
        run: sudo nginx -t && sudo systemctl reload nginx
>>>>>>> 2c96914 (feat: enhance deployment workflow and improve dark theme styling)
