name: Deploy to Production

on:
  push:
    branches: [main]

# При новом push отменяем предыдущий деплой — на сервере всегда окажется код последнего коммита
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      # Всегда клонируем ровно тот коммит, который только что запушен
      - name: Checkout repository (exact commit from this push)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Record deploy (this commit → server)
        run: |
          echo "Deploying commit ${{ github.sha }} (branch ${{ github.ref_name }})"
          echo "Message: ${{ github.event.head_commit.message }}"
          echo "→ Server will get this exact code."

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---------- FRONTEND ----------
      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Build React app
        working-directory: client
        run: npm run build

      - name: Verify React build
        run: |
          test -f client/dist/index.html || (echo "❌ React build missing index.html" && exit 1)

      - name: Deploy frontend to nginx root
        run: |
          sudo rm -rf /home/sam/app/client/dist
          sudo mkdir -p /home/sam/app/client
          sudo cp -r client/dist /home/sam/app/client/dist
          sudo chown -R sam:www-data /home/sam/app/client/dist
          sudo chmod -R 755 /home/sam/app/client/dist

      # ---------- BACKEND ----------
      - name: Install server dependencies
        working-directory: server
        run: npm ci --omit=dev

      - name: Deploy backend to server directory
        run: |
          sudo rm -rf /home/sam/app/server/*
          sudo mkdir -p /home/sam/app/server
          sudo cp -r server/* /home/sam/app/server/
          sudo cp server/.sequelizerc /home/sam/app/server/.sequelizerc 2>/dev/null || true
          sudo cp -r server/node_modules /home/sam/app/server/
          sudo chown -R sam:sam /home/sam/app/server
          sudo chmod -R 755 /home/sam/app/server

      - name: Write backend .env from secrets
        run: |
          sudo tee /home/sam/app/server/.env > /dev/null <<EOF
          PORT=${{ secrets.PORT }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          API_KEY=${{ secrets.API_KEY }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          DB_NAME=${{ secrets.DB_NAME }}
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          LOG_LEVEL=${{ secrets.LOG_LEVEL }}
          EOF
          sudo chown sam:sam /home/sam/app/server/.env
          sudo chmod 600 /home/sam/app/server/.env

      # Корень репозитория: ecosystem.config.cjs нужен для pm2 reload (рабочая директория — /home/sam/app)
      - name: Deploy root config (ecosystem.config.cjs)
        run: |
          sudo cp ecosystem.config.cjs /home/sam/app/
          sudo chown sam:sam /home/sam/app/ecosystem.config.cjs

      - name: Ensure PM2 logs directory exists
        run: sudo mkdir -p /home/sam/logs && sudo chown sam:sam /home/sam/logs

      - name: Run database migrations
        run: |
          cd /home/sam/app/server
          npx sequelize-cli db:migrate

      - name: Restart PM2
        env:
          PORT: ${{ secrets.PORT }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
        run: |
          cd /home/sam/app
          pm2 reload ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production
          pm2 save

      - name: Reload Nginx
        run: sudo nginx -t && sudo systemctl reload nginx

      - name: Verify API health (must return 200)
        env:
          PORT: ${{ secrets.PORT }}
        run: |
          url="http://127.0.0.1:${PORT:-4004}/api/health"
          for i in 1 2 3 4 5 6 7 8 9 10; do
            if curl -sf "$url" >/dev/null; then
              echo "API health OK (200)"
              exit 0
            fi
            echo "Attempt $i: API not ready, retry in 3s..."
            sleep 3
          done
          echo "--- Last curl attempt (verbose) ---"
          curl -v --connect-timeout 5 "$url" || true
          echo ""
          echo "--- PM2 process list ---"
          pm2 list || true
          echo "--- PM2 logs (last 100 lines) ---"
          pm2 logs api --lines 100 --nostream 2>&1 || true
          echo "--- Nginx error log (last 30 lines) ---"
          sudo tail -30 /var/log/nginx/error.log 2>/dev/null || true
          exit 1

      - name: Show PM2 and Nginx logs on failure
        if: failure()
        run: |
          echo "=== PM2 list ==="
          pm2 list || true
          echo "=== PM2 logs api (last 150 lines) ==="
          pm2 logs api --lines 150 --nostream 2>&1 || true
          echo "=== Nginx error log (last 50 lines) ==="
          sudo tail -50 /var/log/nginx/error.log 2>/dev/null || true