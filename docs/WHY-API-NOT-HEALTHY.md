# Почему «❌ API is not healthy»

## Главная причина в этом проекте

В **server/src/index.js** сервер **не запускает HTTP (app.listen)** пока не подключится к БД:

```js
(async () => {
  try {
    await db.sequelize.authenticate();
    await db.sequelize.sync();
    // ...
    app.listen(PORT, ...);
  } catch (err) {
    console.error("❌ DB connection failed:", err);
    process.exit(1);   // ← процесс завершается, порт не слушается
  }
})();
```

Если на сервере **не удаётся подключиться к MySQL** (неверный пароль, хост, база, сеть), процесс падает и **никто не слушает порт 4004**. Nginx проксирует запросы на 4004 → соединение не устанавливается → фронт получает ошибку → «API is not healthy».

---

## Что проверить на сервере (по порядку)

### 1. Логи приложения (PM2)

```bash
pm2 logs api --lines 50
# или
tail -50 /home/sam/logs/api-err.log
```

Если видишь **«❌ DB connection failed»** — причина в БД (учётные данные, доступность MySQL, сеть).

### 2. Слушает ли кто-то порт 4004

```bash
sudo ss -tlnp | grep 4004
# или
sudo lsof -i :4004
```

Если пусто — процесс не запущен или упал (часто из‑за ошибки БД).

### 3. Ответ бэкенда напрямую (минуя Nginx)

```bash
curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4004/api/health
curl http://127.0.0.1:4004/api/health
```

- **Connection refused** — приложение не слушает 4004 (п. 1–2).
- **200** и `{"status":"OK",...}` — бэкенд в порядке, смотреть Nginx и как открываешь сайт (домен/порт).

### 4. Nginx

- В конфиге **proxy_pass** должен быть **без слэша в конце**: `proxy_pass http://127.0.0.1:4004;` (не `4004/`).
- Порт должен совпадать с **PORT** в `/home/sam/app/server/.env` (обычно 4004).

### 5. Файл .env на сервере

```bash
cat /home/sam/app/server/.env
```

Должны быть **DB_HOST**, **DB_USER**, **DB_PASSWORD** (или **DB_PASS**), **DB_NAME**, **PORT**. Если пароль с `#`, в файле он должен быть в кавычках.

---

## Итог

| Симптом | Причина |
|--------|--------|
| В логах «DB connection failed» | Неверные/неполные данные БД или MySQL недоступен |
| Порт 4004 не слушается | Процесс не стартовал или упал (часто из‑за БД) |
| curl на 127.0.0.1:4004 даёт 200, а в браузере «not healthy» | Nginx (порт, слэш в proxy_pass) или другой домен/порт |

Сначала всегда смотри **pm2 logs** и **порт 4004** — по ним видно, запустилось ли приложение вообще.
